---
title: 'STAT 327: Project'
author: "Dawson Kinsman and Sabastian Zuhorski"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: yeti
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(gtools)
library(knitr)
library(kableExtra)
```

# Functions and Classes
Some functions and classes are imported from a separate file.
```{r}
source('functions.R')

randomSimulation = function(numSims, boardSize = 3, board = NA, df, seed = 0, colName = NA){
  set.seed(seed)
  
  winners<- replicate(numSims, randtictactoe(boardSize, board))
  #table(winners)
  
  if (is.na(colName)){
    hist(winners, 
       main = paste0('Results of 1,000 ',boardSize,'x', boardSize,' Tic-Tac-Toe Games'))
    df2 <- data.frame(Winner = winners, 
                  'Board Size' = rep(paste0(boardSize,'x', boardSize), numSims))
  }
  else if (colName == 'First Move' | colName == 'Second Move'){
    if (colName == 'First Move'){
      df2 <- data.frame(Winner = winners, 'Move' = rep(which(board==1), numSims))}
    else{
      df2 <- data.frame(Winner = winners, 'First Move' = rep(which(board==1)),  
                        'Second Move' = rep(which(board==-1), numSims))}
    
  }
  else {
    df2 <- data.frame(Winner = winners, numSims = rep(as.character(colName),numSims))
  }
  
  df <- rbind(df, df2)
  
  return(df)
}
```
## Constant Values
```{r}
n = 1e3
```

# How does the size of the board effect the probability of Player 1 winning?
                              
First, we simulate the data using the functions we have written. We choose to run 1,000 simulations for boards with dimensions $3\times 3$, $4 \times 4$, $5 \times 5$, and $10\times 10$. 
```{r}
df <- data.frame(matrix(ncol = 2, nrow = 0))
colnames(df) <- c('Winner', 'Board Size')

df <- randomSimulation(n, 3, df = df)
df <- randomSimulation(n, 4, df = df, seed = 1)
df <- randomSimulation(n, 5, df = df, seed = 2)
df <- randomSimulation(n, 10, df = df, seed = 3)
```

We can visualize the number of times each player wins using a bar chart. 
```{r}
boards <- c('3x3','4x4','5x5','10x10')
df$Board.Size <- factor(df$Board.Size, levels = boards)
df$Winner <- factor(df$Winner, levels = c(1, -1, 0), 
                    labels = c('Player 1', 'Player 2', 'Draw'))

ggplot(df, aes(Winner)) + 
  geom_bar(aes(fill = Board.Size), position = 'dodge', color = 'black', 
           alpha = 0.75) +
  ggtitle('Winner of 1,000 Tic-Tac-Toe Games', 
          subtitle = 'Using Boards of Various Dimensions')
```

We then offer 
```{r}
results <- data.frame(matrix(ncol = 3, nrow = 0))
colnames(results) <- c('Winner', 'Board Size', 'Probability')

for (i in boards){
  df_board <- df %>% filter(Board.Size == i)
  p1 <- length(df_board$Winner[df_board$Winner == 'Player 1']) / n; p1
  p2 <- length(df_board$Winner[df_board$Winner == 'Player 2']) / n; p2
  draw <- length(df_board$Winner[df_board$Winner == 'Draw']) / n; draw
  
  res <- data.frame(Winner = c('Player 1', 'Player 2', 'Draw'), 
                 'Board Size' = i, Probability = c(p1,p2, draw))
  results <- rbind(results, res)
}

pt <- pivot_wider(results, id_cols = Board.Size, names_from = Winner, values_from = Probability); pt
knitr::kable(pt, align = 'cccc') %>% kable_styling(full_width = F)
```

# For which first move does Player 1 have the highest probability of winning?
There are 3 general first moves, those being, 1, 4, and 5. All of the other first moves can be written as a rotation or reflection of these three
Let's simulate 1,000 games using each of the afro 

```{r}
board1 <- array(c(1, rep(NA, 8)), dim = c(3,3))
board4 <- array(c(rep(NA, 3), 1, rep(NA, 4)), dim = c(3,3))
board5 <- array(c(rep(NA,4),1,rep(NA,4)), dim = c(3,3))

df1 <- data.frame(matrix(ncol = 2, nrow = 0))
colnames(df1) <- c('Winner', 'Move')

df1 <- randomSimulation(n, 3, board1, df = df1, seed = 0, 'First Move')
df1 <- randomSimulation(n, 3, board4, df = df1, seed = 1, 'First Move')
df1 <- randomSimulation(n, 3, board5, df = df1, seed = 2, 'First Move')
```

```{r}
df1$Move <- as.factor(df1$Move)
df1$Winner <- factor(df1$Winner, levels = c(1, -1, 0), 
                    labels = c('Player 1', 'Player 2', 'Draw'))

ggplot(df1, aes(Winner)) + 
  geom_bar(aes(fill = Move), position = 'dodge', color = 'black', 
           alpha = 0.75) +
  ggtitle('Winner of 1,000 Tic-Tac-Toe Games', 
          subtitle = 'Using Different First Moves')
```

```{r}
results <- data.frame(matrix(ncol = 3, nrow = 0))
colnames(results) <- c('Winner', 'First Move', 'Probability')

for (i in c(1,4,5)){
  df_fmove <- df1 %>% filter(Move == i)
  p1 <- length(df_fmove$Winner[df_fmove$Winner == 'Player 1']) / n; p1
  p2 <- length(df_fmove$Winner[df_fmove$Winner == 'Player 2']) / n; p2
  draw <- length(df_fmove$Winner[df_fmove$Winner == 'Draw']) / n; draw
  
  res <- data.frame(Winner = c('Player 1', 'Player 2', 'Draw'), 
                 'First Move' = i, Probability = c(p1,p2, draw))
  results <- rbind(results, res)
}

pt <- pivot_wider(results, id_cols = First.Move, names_from = Winner, values_from = Probability); pt
knitr::kable(pt, align = 'cccc') %>% kable_styling(full_width = F)
```

# For which second move does Player 2 have the highest probability of winning?
```{r}
board1 <- array(c(rep(NA,2), 1, rep(NA, 3), -1, rep(NA, 2)), dim = c(3,3))
board2 <- array(c(rep(NA,2), 1, rep(NA, 4), -1, NA), dim = c(3,3))
board3 <- array(c(rep(NA,2),-1,rep(NA,5), 1), dim = c(3,3))
board4 <- array(c(rep(NA,4),-1,rep(NA,3), 1), dim = c(3,3))
board5 <- array(c(rep(NA,5),-1,rep(NA,2), 1), dim = c(3,3))
board6 <- array(c(rep(NA,2),-1,rep(NA,4), 1, NA), dim = c(3,3))
board7 <- array(c(NA,-1,rep(NA,5), 1, NA), dim = c(3,3))
board8 <- array(c(rep(NA,5),1,NA, -1, NA), dim = c(3,3))
board9 <- array(c(rep(NA,4),-1, 1, rep(NA,3)), dim = c(3,3))
board10 <- array(c(rep(NA,5),1,rep(NA,2), -1), dim = c(3,3))
board11 <- array(c(rep(NA,4),1,rep(NA,3), -1), dim = c(3,3))
board12 <- array(c(rep(NA,4),1, -1, rep(NA, 3)), dim = c(3,3))

df1 <- data.frame(matrix(ncol = 3, nrow = 0))
colnames(df1) <- c('Winner', 'First Move', 'Second Move')

df1 <- randomSimulation(n, 3, board1, df = df1, seed = 0, 'Second Move')
df1 <- randomSimulation(n, 3, board2, df = df1, seed = 1, 'Second Move')
df1 <- randomSimulation(n, 3, board3, df = df1, seed = 2, 'Second Move')
df1 <- randomSimulation(n, 3, board4, df = df1, seed = 3, 'Second Move')
df1 <- randomSimulation(n, 3, board5, df = df1, seed = 4, 'Second Move')
df1 <- randomSimulation(n, 3, board6, df = df1, seed = 5, 'Second Move')
df1 <- randomSimulation(n, 3, board7, df = df1, seed = 6, 'Second Move')
df1 <- randomSimulation(n, 3, board8, df = df1, seed = 7, 'Second Move')
df1 <- randomSimulation(n, 3, board9, df = df1, seed = 8, 'Second Move')
df1 <- randomSimulation(n, 3, board10, df = df1, seed = 9, 'Second Move')
df1 <- randomSimulation(n, 3, board11, df = df1, seed = 10, 'Second Move')
df1 <- randomSimulation(n, 3, board12, df = df1, seed = 11, 'Second Move')

df1$First.Move <- as.factor(df1$First.Move)
df1$Second.Move <- as.factor(df1$Second.Move)
df1$Winner <- factor(df1$Winner, levels = c(1, -1, 0), 
                    labels = c('Player 1', 'Player 2', 'Draw'))

ggplot(df1, aes(Winner)) + 
  geom_bar(aes(fill = Second.Move), position = 'dodge', color = 'black', 
           alpha = 0.75) +
  ggtitle('Winner of 1,000 Tic-Tac-Toe Games', 
          subtitle = 'Using Different Second Moves')

ggplot(df1, aes(Winner)) + 
  geom_bar(aes(fill = Second.Move), position = 'dodge', color = 'black', 
           alpha = 0.75) + facet_wrap(~First.Move) +
  ggtitle('Winner of 1,000 Tic-Tac-Toe Games', 
          subtitle = 'Using Different Second Moves Faceted by First Move')
```
```{r}
results <- data.frame(matrix(ncol = 4, nrow = 0))
colnames(results) <- c('Winner', 'Second Move', 'Probability')

for (i in 1:9){
  df_fmove <- df1 %>% filter(First.Move==i)
  print(dim(df_fmove))
  for (j in 1:9){
  df_smove <- df_fmove %>% filter(Second.Move == j)
  p1 <- length(df_smove$Winner[df_smove$Winner == 'Player 1']) / dim(df_smove)[1]; p1
  p2 <- length(df_smove$Winner[df_smove$Winner == 'Player 2']) / dim(df_smove)[1]; p2
  draw <- length(df_smove$Winner[df_smove$Winner == 'Draw']) / dim(df_smove)[1]; draw
  
  res <- data.frame(Winner = c('Player 1', 'Player 2', 'Draw'), 'First Move' = i,
                 'Second Move' = j, Probability = c(p1,p2, draw))
  results <- rbind(results, res)
  }
}

pt <- pivot_wider(results, id_cols = c(First.Move,Second.Move), names_from = Winner, values_from = Probability)
pt <- na.omit(pt); pt
knitr::kable(pt, align = 'cccc') %>% kable_styling(full_width = F)
```

# Convergence of Random vs. Random Probabilities:
```{r}
set.seed(0)
df <- data.frame(matrix(ncol = 2, nrow = 0))
colnames(df) <- c('Winner', 'numSims')

df <- randomSimulation(10, 3, df = df, colName = '10')
df <- randomSimulation(100, 3, df = df, colName = '100')
df <- randomSimulation(100, 3, df = df, colName = '1000')
df <- randomSimulation(1000, 3, df = df, colName = '10000')
df <- randomSimulation(10000, 3, df = df, colName = '100000')

df$numSims <- as.factor(df$numSims)
df$Winner <- factor(df$Winner, levels = c(1, -1, 0), 
                    labels = c('Player 1', 'Player 2', 'Draw'))

df %>% count(Winner, numSims) %>% group_by( numSims) %>% 
  mutate(prob = n/sum(n)) %>% 
  ggplot(aes(x = Winner, y = prob, fill = numSims)) + 
  geom_col(position = position_dodge(), color = 'black')
```


# Using Monte Carlo Search Tree

## vs. Random Simulation 

```{r}
MCTSvsRandomSim = function(numSims, first = c('MCTS', 'random'), iterations = 500, board = NA, player = -1){
  if (length(which(is.na(board)))==1) board = array(rep(NA, 3^2), 
                                                    dim = c(3, 3))
  
  if (first == 'MCTS') winner = replicate(numSims, 
                                          MCTSvsRandom(iterations = iterations, board = board, player = player))
  else winner = replicate(numSims, 
                          RandomvsMCTS(iterations = iterations, board = board, player = player))
  return(winner)
}
```

```{r, echo = F, results='hide'}
set.seed(0)
winnerMCTS = MCTSvsRandomSim(numSims =100, first = 'MCTS', iterations = 500)
winnerRandom = MCTSvsRandomSim(numSims = 100, first = 'random', iterations = 500)
```
```{r}
dfWinners <- pivot_longer(data.frame(winnerMCTS, winnerRandom), 
                          cols = c('winnerMCTS', 'winnerRandom'))
ggplot(dfWinners) + 
  geom_bar(aes(value, fill = name), position = 'dodge', color = 'black', 
           alpha = 0.75) +
  ggtitle('Winner of 100 Tic-Tac-Toe Games', 
          subtitle = 'Depending on who goes First')
```

## Comparing MCTS with different number of iterations
```{r}
set.seed(0)

start.time <- Sys.time()
winner10 = MCTSvsRandomSim(numSims =10, first = 'MCTS', iterations = 10)
winner100 = MCTSvsRandomSim(numSims =10, first = 'MCTS', iterations = 100)
winner500 = MCTSvsRandomSim(numSims =10, first = 'MCTS', iterations = 500)
winner1000= MCTSvsRandomSim(numSims =10, first = 'MCTS', iterations = 1000)
winner5000= MCTSvsRandomSim(numSims =10, first = 'MCTS', iterations = 5000)
#winner200 = MCTSvsRandomSim(numSims =1000, first = 'MCTS', iterations = 200)
end.time <- Sys.time()
time.taken <- end.time - start.time; time.taken
```
```{r}
dfIter = data.frame(winner10, winner100, winner500, winner1000, winner5000)
winnerIterations = pivot_longer(dfIter, cols = colnames(dfIter))
winnerIterations$numSims = 
  factor(winnerIterations$name, levels = c('winner10', 'winner100', 
                                           'winner500', 'winner1000', 'winner5000'), 
                               labels = c('10 simulations', '100 simulations', 
                                          '500 simulations', '1000 simulations',
                                          '5000 simulations'))

ggplot(winnerIterations) + 
  geom_bar(aes(value, fill = numSims), position = 'dodge', color = 'black', 
           alpha = 0.75) +
  ggtitle('Winner of 10 Tic-Tac-Toe Games', 
          subtitle = 'with Different Number of MCTS Simulations')
```
```{r}
set.seed(0)
start.time <- Sys.time()
winnerParam = MCTSvsRandomSim(numSims =100, first = 'MCTS', iterations = 500)
end.time <- Sys.time()
time.taken <- end.time - start.time; time.taken
dftest = data.frame(winnerParam)
ggplot(dftest) + geom_bar(aes(winnerParam))
```
## Depending on the first board ()
```{r}
board1 <- array(c(-1, rep(NA, 8)), dim = c(3,3))
board4 <- array(c(rep(NA, 3), -1, rep(NA, 4)), dim = c(3,3))
board5 <- array(c(rep(NA,4),-1,rep(NA,4)), dim = c(3,3))

set.seed(0)
start.time <- Sys.time()
winnerb1= MCTSvsRandomSim(numSims =100, first = 'MCTS', iterations = 500, board = board1, player = -1)
winnerb4= MCTSvsRandomSim(numSims =100, first = 'MCTS', iterations = 500, board = board4, player = -1)
winnerb5= MCTSvsRandomSim(numSims =100, first = 'MCTS', iterations = 500, board = board5, player = -1)
end.time <- Sys.time()
time.taken <- end.time - start.time; time.taken
```
```{r}
winnerFirst <- data.frame(winnerb1, winnerb4, winnerb5)
winnerFirstLong = pivot_longer(winnerFirst, cols =colnames(winnerFirst))
winnerFirstLong$winner = factor(winnerFirstLong$value, levels = c(-1,0,1),
                                labels = c('Random', 'Draw', 'MCTS'))

ggplot(winnerFirstLong) + 
  geom_bar(aes(winner, fill = name), position = 'dodge', color = 'black', 
           alpha = 0.75) +
  ggtitle('Winner of 100 Tic-Tac-Toe Games', 
          subtitle = 'with Different Starting Moves (MCTS is Player 2)')
```

```{r}
winner = replicate(100, MCTSvsMCTS(iterations = 500, player = -1))
hist(winner)
```


# Notes
- We can check if 3 in a row by summing three entries and checking if they are 0 mod 3.
- Right now Player1 is coded as 1, Player2 is coded as -1, and a draw is 0. And I am using winner as an indicator if the game is finished. If not, then winner is NULL.

